# smplboards-TCS3530
Arduino library for ams-OSRAM TCS3530 XYZ colour sensor

## Installation

1. Download this repository from GitHub as a .zip file.

2. In Arduino IDE, navigate to `Sketch` > `Include Library` > `Add .ZIP Library...`, then select the downloaded .zip file to install the library.

3. When installed, you can include the library header by selecting it in `Sketch` > `Include Library`, and view example sketches in `File` > `Examples`.

## Wiring

| Pin | Description |
|---|---|
| VCC | Power Pin. Connect to 2.5-5V power source |
| GND | Ground Pin. Connect to GND pin of microcontroller |
| SCL | I2C Clock Pin. Connect to SCL pin on microcontroller |
| SDA | I2C Data Pin. Connect to SDA pin on microcontroller |
| INT | Interrupt Pin. Can be used with interrupt-capable digital pin on microcontroller to read data once it is ready, resulting in minimized timing jitter |
| VSYNC | VSYNC or GPIO Pin. Can be used to synchronize measurements across multiple sensors |

This board can receive supply voltages ranging from 2.5V to 5V, but the pins cannot tolerate voltages above supply voltage. E.g. if VCC is supplied with 2.5V, the signal pins should not receive signals above 2.5V.

There is a JST-SH 6 pin connector (1mm pitch) for more secure and compact wiring.

### A Small Note
This board consists of a TCS3530 sensor, but also an LP5816 LED driver to control the 4 bright LEDs on the sensor board. For clarity, these 2 components are controlled with separate objects in code, although both operate on the same I2C bus.

## API Reference (LP5816)

### Structs

* `LP5816_config`: Driver configuration
  * `LP5816_max_current max_current`: Maximum current per LED channel (represents 100% current, see `LP5816_max_current` enum for options)
  * `LP5816_fade_time fade_time`: Time taken by driver to transition between PWM duty cycle values (see `LP5816_fade_time` for options)
  * `bool fade_en[4]`: Enables/disables fade between PWM duty cycle values.
  * `bool exp_dim_en[4]`: Enables/disables exponential curve for PWM duty cycle dimming.
  * `bool channel_en[4]`: Enables/disables output for each LED channel.

* `LP5816_output`: Driver output
  * `uint8_t current[4]`: LED current from 0% to 100% [0-255]
  * `uint8_t duty_cycle[4]`: PWM duty cycle from 0% to 100% [0-255]

Note: Since the sensor samples at a high frequency, it can likely detect the flicker generated by PWM dimming. Hence, it is recommended to leave the duty cycle at 100% (value 255) all the time, and vary brightness with the LED current.

### Enums

* `LP5816_max_current`
  * `LP5816_MA_25_5`: 25.5mA
  * `LP5816_MA_51`: 51mA

* `LP5816_fade_time`: 
  * `LP5816_S_0`: 0s
  * `LP5816_S_0_05`: 0.05s
  * `LP5816_S_0_10`: 0.10s
  * `LP5816_S_0_15`: 0.15s
  * `LP5816_S_0_20`: 0.20s
  * `LP5816_S_0_25`: 0.25s
  * `LP5816_S_0_30`: 0.30s
  * `LP5816_S_0_35`: 0.35s
  * `LP5816_S_0_40`: 0.40s
  * `LP5816_S_0_45`: 0.45s
  * `LP5816_S_0_50`: 0.50s
  * `LP5816_S_1`: 1s
  * `LP5816_S_2`: 2s
  * `LP5816_S_4`: 4s
  * `LP5816_S_6`: 6s
  * `LP5816_S_8`: 8s

* `LP5816_ch`: Used to index for a LED channel in the structs above.
  * `LP5816_CH_0`
  * `LP5816_CH_1`
  * `LP5816_CH_2`
  * `LP5816_CH_3`

Note: The LED channel for each LED is labelled on the sensor board!

### Constructors

#### `LP5816(TwoWire& wire)`

* `wire`: I2C object used for communications (e.g. `Wire` or `Wire1`)

### Functions

#### `bool begin(const LP5816_config& config)`

Initializes LED driver with given settings. Call this function before all others.

* `config`: Driver configuration
* Returns: `true` if driver was successfully initialized, `false` otherwise

#### `void setConfig(const LP5816_config& config)`

Writes driver configuration to LED driver.

* `config`: Driver configuration

#### `void setOutput(const LP5816_output& output)`

Writes driver output to LED driver.

* `output`: Driver output

## API Reference (TCS3530)

### Structs

Additionally, the library uses structs to organize groups of data to be passed into or modified by functions, each listed below:

* `TCS3530_config`: Sensor configuration
  * `TCS3530_trigger_mode trigger_mode`: Amount of time represented as 1 wait time step (see `TCS3530_trigger_mode` enum for options).
  * `uint8_t wait_time`: Number of wait time steps spent waiting between readings [0-2047].
  * `uint16_t sample_time`: Number of 1.3888us steps spent on one sensor sample (subtracted by 1) [179-2047].
  * `uint16_t sample_count`: Number of samples measured for one sensor reading (subtracted by 1) [7-2047].
  * `uint8_t gain[8]`: Gain for each sensor channel [0-15].

* `TCS3530_status`: Sensor status data
  * `bool mod_analog_sat_any`: `true` when any of the channel readings have reached max intensity
  * `bool mod_analog_sat[8]`: `true` when a specific channel's reading have reached max intensity
  * `bool fifo_overflow`: `true` when sensor internal FIFO is full and data from the FIFO is lost.
  
* `TCS3530_raw_data`: Raw readings. Internal array can be indexed with the options under `TCS3530_als_ch` enum.
  * `uint16_t data[8]`: Each element represents reading for each colour channel. 

* `TCS3530_norm_data`: Normalized readings (and thresholds used). Internal array can be indexed with the options under `TCS3530_als_ch` enum.
  * `uint16_t low[8]`: Low thresholds. Raw readings with this value (or lower) will be normalized to 0.
  * `uint16_t high[8]`: High thresholds. Raw readings with this value (or higher) will be normalized to 65535.
  * `uint16_t data[8]`: Normalized readings.

* `TCS3530_lab_data`: CIELAB values. Internal array can be indexed with the options under `TCS3530_lab_ch` enum.
  * `uint16_t data[3]`: CIELAB values.

### Enums

* `TCS3530_als_ch`: Used to index for a sensor channel in the structs above.
  * `TCS3530_X`
  * `TCS3530_Y`
  * `TCS3530_Z`
  * `TCS3530_IR`
  * `TCS3530_HGL`
  * `TCS3530_HGH`
  * `TCS3530_CLEAR`
  * `TCS3530_FLICKER`

* `TCS3530_lab_ch`: Used to index for a LAB component in `TCS3530_lab_data` objects
  * `TCS3530_L`
  * `TCS3530_A`
  * `TCS3530_B`

* `TCS3530_trigger_mode`: Defines the wait time step between readings
  * `TCS3530_OFF`: Wait time is always 0s
  * `TCS3530_NORMAL`: 2.844ms
  * `TCS3530_LONG`: 45.511ms
  * `TCS3530_FAST`: 88.889us
  * `TCS3530_FAST_LONG`: 1.422ms
  * `TCS3530_VSYNC`: Sensor waits until VSYNC pin input receives a falling edge (HIGH to LOW transition)

### Constructors

#### `TCS3530(TwoWire& wire)`

* `wire`: I2C object used for communications (e.g. `Wire` or `Wire1`)

### Functions

#### `bool begin(const TCS3530_config& config)`

Initializes sensor with given settings. Call this function before all others.

* `config`: Sensor configuration
* Returns: `true` if sensor was successfully initialized, `false` otherwise

Note: If `begin()` returns `true`, continuous measurement automatically begins unless the sensor is set to wait for a VSYNC signal. Interrupts are also enabled on the INT pin; there will be a falling edge on the pin when a new reading is ready.

#### `void setConfig(const TCS3530_config& config)`

Writes sensor configuration to sensor.

* `config`: Sensor configuration

#### `void getStatus(TCS3530_status& status)`

Updates input object with sensor status data.

* `status`: Object to be updated with sensor status

#### `bool updateRawData(TCS3530_raw_data& raw)`

If a new reading is ready, updates input object with new reading. If no new reading is ready, raw is left unchanged.

* `raw`: Object to be updated with raw readings
* Returns: `true` if input object was updated, `false` otherwise

#### `void convertRawToNorm(const TCS3530_raw_data& raw, TCS3530_norm_data& result)`

Converts raw readings to normalized readings based on thresholds set in `result`.

* `raw`: Object containing raw readings
* `result`: Object which contains normalization thresholds, and is to be updated with normalised readings

#### `void convertNormToLab(const TCS3530_norm_data& norm, TCS3530_lab_data& result)`

Converts normalized readings to CIELAB data.

* `norm`: Object containing normalized readings
* `result`: Object to be updated with CIELAB data
